// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum SubscriptionTier {
  FREE
  PRO
  TEAM
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  PAST_DUE
  TRIALING
  EXPIRED
}

enum RecurrenceFrequency {
  DAILY
  WEEKLY
  MONTHLY
  YEARLY
}

enum RecurrenceEndType {
  NEVER
  ON_DATE
  AFTER_COUNT
}

enum CollaboratorRole {
  OWNER
  EDITOR
  VIEWER
}

enum PomodoroSessionType {
  WORK
  SHORT_BREAK
  LONG_BREAK
}

enum TemplateVariableType {
  TEXT
  NUMBER
  DATE
  SELECT
  BOOLEAN
}

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  todos            Todo[]
  recurringTodos   RecurringTodo[]
  subscription     Subscription?
  paymentMethods   PaymentMethod[]
  ownedLists       SharedList[]
  collaborations   Collaborator[]
  timeEntries      TimeEntry[]
  pomodoroSessions PomodoroSession[]
  templates        Template[]

  @@index([email])
}

model Todo {
  id          Int       @id @default(autoincrement())
  title       String
  description String
  dueDate     DateTime
  isComplete  Boolean   @default(false)
  priority    Priority  @default(MEDIUM)

  userId      Int
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Shared list relation (null if personal todo)
  listId      Int?
  list        SharedList? @relation(fields: [listId], references: [id], onDelete: Cascade)

  // Recurring todo relation (null if not a recurring instance)
  recurringTodoId  Int?
  recurringTodo    RecurringTodo? @relation(fields: [recurringTodoId], references: [id], onDelete: SetNull)
  recurringDate    DateTime?      // The specific date this instance represents

  deletedAt   DateTime?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  tags             TodoTag[]
  timeEntries      TimeEntry[]
  pomodoroSessions PomodoroSession[]

  @@index([dueDate])
  @@index([isComplete])
  @@index([priority])
  @@index([deletedAt])
  @@index([userId])
  @@index([listId])
  @@index([recurringTodoId])
}

model Tag {
  id        Int       @id @default(autoincrement())
  name      String    @unique
  color     String?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  todos     TodoTag[]

  @@index([name])
}

model TodoTag {
  todoId    Int
  tagId     Int

  todo      Todo     @relation(fields: [todoId], references: [id], onDelete: Cascade)
  tag       Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  assignedAt DateTime @default(now())

  @@id([todoId, tagId])
  @@index([todoId])
  @@index([tagId])
}

model Subscription {
  id                    Int                @id @default(autoincrement())
  userId                Int                @unique
  user                  User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  tier                  SubscriptionTier   @default(FREE)
  status                SubscriptionStatus @default(ACTIVE)

  // Stubbed Stripe fields (will be null in stub mode)
  stripeCustomerId      String?            @unique
  stripeSubscriptionId  String?            @unique
  stripePriceId         String?

  currentPeriodStart    DateTime           @default(now())
  currentPeriodEnd      DateTime?
  cancelAtPeriodEnd     Boolean            @default(false)

  trialEndsAt           DateTime?

  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt

  billingHistory        BillingHistory[]

  @@index([userId])
  @@index([tier])
  @@index([status])
}

model PaymentMethod {
  id               Int      @id @default(autoincrement())
  userId           Int
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Stubbed payment method details
  type             String   // 'card', 'paypal', etc.
  last4            String?  // Last 4 digits of card
  brand            String?  // 'visa', 'mastercard', etc.
  expiryMonth      Int?
  expiryYear       Int?

  isDefault        Boolean  @default(false)

  // Stubbed Stripe field
  stripePaymentMethodId String? @unique

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([userId])
}

model BillingHistory {
  id             Int          @id @default(autoincrement())
  subscriptionId Int
  subscription   Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  amount         Float        // Amount in dollars
  currency       String       @default("usd")

  status         String       // 'succeeded', 'pending', 'failed'
  description    String

  // Stubbed Stripe fields
  stripeInvoiceId String?     @unique
  stripeChargeId  String?     @unique

  billingDate    DateTime     @default(now())
  paidAt         DateTime?

  createdAt      DateTime     @default(now())

  @@index([subscriptionId])
  @@index([billingDate])
}

model RecurringTodo {
  id          Int                 @id @default(autoincrement())
  userId      Int
  user        User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Template fields
  title       String
  description String
  priority    Priority            @default(MEDIUM)

  // Recurrence pattern (rrule format)
  frequency   RecurrenceFrequency
  interval    Int                 @default(1)  // e.g., every 2 weeks
  byWeekDay   String?              // JSON array: ["MO", "FR"] for weekly
  byMonthDay  Int?                 // For monthly: day of month (1-31)

  // Recurrence bounds
  startDate   DateTime
  endType     RecurrenceEndType   @default(NEVER)
  endDate     DateTime?            // For ON_DATE
  count       Int?                 // For AFTER_COUNT

  // Generation tracking
  lastGenerated DateTime?           // Last date we generated instances for
  isActive    Boolean             @default(true)

  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  // Relations
  instances   Todo[]
  exceptions  RecurrenceException[]

  @@index([userId])
  @@index([startDate])
  @@index([isActive])
}

model RecurrenceException {
  id              Int           @id @default(autoincrement())
  recurringTodoId Int
  recurringTodo   RecurringTodo @relation(fields: [recurringTodoId], references: [id], onDelete: Cascade)

  originalDate    DateTime      // The date this exception applies to
  action          String        // 'skip' or 'reschedule'
  newDate         DateTime?     // For reschedule action

  createdAt       DateTime      @default(now())

  @@index([recurringTodoId])
  @@index([originalDate])
  @@unique([recurringTodoId, originalDate])
}

model SharedList {
  id          Int      @id @default(autoincrement())
  name        String
  description String?
  color       String?  // Hex color for UI

  ownerId     Int
  owner       User     @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  isPublic    Boolean  @default(false)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  todos        Todo[]
  collaborators Collaborator[]

  @@index([ownerId])
  @@index([isPublic])
}

model Collaborator {
  id          Int              @id @default(autoincrement())
  listId      Int
  list        SharedList       @relation(fields: [listId], references: [id], onDelete: Cascade)

  userId      Int
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  role        CollaboratorRole @default(VIEWER)

  invitedAt   DateTime         @default(now())
  acceptedAt  DateTime?

  @@unique([listId, userId])
  @@index([listId])
  @@index([userId])
}

model TimeEntry {
  id          Int      @id @default(autoincrement())
  userId      Int
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  todoId      Int?
  todo        Todo?    @relation(fields: [todoId], references: [id], onDelete: SetNull)

  startTime   DateTime
  endTime     DateTime?
  duration    Int?     // Duration in seconds (calculated when ended)

  isActive    Boolean  @default(true)  // Only one can be active per user at a time
  description String?  // Optional note about what was done

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@index([todoId])
  @@index([startTime])
  @@index([isActive])
}

model PomodoroSession {
  id          Int                  @id @default(autoincrement())
  userId      Int
  user        User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  todoId      Int?
  todo        Todo?                @relation(fields: [todoId], references: [id], onDelete: SetNull)

  type        PomodoroSessionType  @default(WORK)
  duration    Int                  // Duration in minutes (25 for work, 5 for short break, 15 for long break)

  startTime   DateTime
  endTime     DateTime?
  completed   Boolean              @default(false)

  createdAt   DateTime             @default(now())

  @@index([userId])
  @@index([todoId])
  @@index([startTime])
  @@index([completed])
}

model Template {
  id          Int      @id @default(autoincrement())
  name        String
  description String?

  // Template content
  title       String
  content     String  // The template body with {{variable}} placeholders
  priority    Priority @default(MEDIUM)

  // Ownership
  userId      Int?     // null for system templates
  user        User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Categorization
  categoryId  Int?
  category    TemplateCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  isPublic    Boolean  @default(false)  // Public templates available to all users
  isSystem    Boolean  @default(false)  // System templates (curated)

  // Usage tracking
  useCount    Int      @default(0)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  variables   TemplateVariable[]

  @@index([userId])
  @@index([categoryId])
  @@index([isPublic])
  @@index([isSystem])
}

model TemplateVariable {
  id          Int                  @id @default(autoincrement())
  templateId  Int
  template    Template             @relation(fields: [templateId], references: [id], onDelete: Cascade)

  name        String                // Variable name (e.g., "client_name")
  label       String                // Display label (e.g., "Client Name")
  type        TemplateVariableType  @default(TEXT)

  defaultValue String?              // Default value if not provided
  required    Boolean              @default(false)

  // For SELECT type
  options     String?              // JSON array of options: ["Option 1", "Option 2"]

  // Ordering
  order       Int                  @default(0)

  createdAt   DateTime             @default(now())

  @@index([templateId])
}

model TemplateCategory {
  id          Int        @id @default(autoincrement())
  name        String     @unique
  description String?
  icon        String?    // Icon name or emoji
  color       String?    // Hex color

  isSystem    Boolean    @default(false)

  createdAt   DateTime   @default(now())

  templates   Template[]

  @@index([name])
}
