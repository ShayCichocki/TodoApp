// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum SubscriptionTier {
  FREE
  PRO
  TEAM
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  PAST_DUE
  TRIALING
  EXPIRED
}

enum RecurrenceFrequency {
  DAILY
  WEEKLY
  MONTHLY
  YEARLY
}

enum RecurrenceEndType {
  NEVER
  ON_DATE
  AFTER_COUNT
}

enum CollaboratorRole {
  OWNER
  EDITOR
  VIEWER
}

enum PomodoroSessionType {
  WORK
  SHORT_BREAK
  LONG_BREAK
}

enum TemplateVariableType {
  TEXT
  NUMBER
  DATE
  SELECT
  BOOLEAN
}

enum NotificationType {
  TASK_DUE_SOON
  TASK_OVERDUE
  TASK_ASSIGNED
  TASK_COMPLETED
  DIGEST_DAILY
  DIGEST_WEEKLY
  REMINDER
}

enum NotificationChannel {
  EMAIL
  BROWSER_PUSH
  IN_APP
}

enum NotificationStatus {
  PENDING
  SENT
  FAILED
  READ
}

enum DigestFrequency {
  DAILY
  WEEKLY
  NEVER
}

enum CalendarProvider {
  GOOGLE
  OUTLOOK
  APPLE
}

enum SyncDirection {
  TODO_TO_CALENDAR
  CALENDAR_TO_TODO
  BIDIRECTIONAL
}

enum SyncStatus {
  ACTIVE
  PAUSED
  ERROR
}

enum WorkspaceMemberRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

enum ActivityAction {
  CREATED
  UPDATED
  DELETED
  COMPLETED
  ASSIGNED
  COMMENTED
  MEMBER_ADDED
  MEMBER_REMOVED
  MEMBER_ROLE_CHANGED
}

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  todos                 Todo[]
  recurringTodos        RecurringTodo[]
  subscription          Subscription?
  paymentMethods        PaymentMethod[]
  ownedLists            SharedList[]
  collaborations        Collaborator[]
  timeEntries           TimeEntry[]
  pomodoroSessions      PomodoroSession[]
  templates             Template[]
  notifications         Notification[]
  notificationSettings  NotificationSettings?
  calendarConnections   CalendarConnection[]
  ownedWorkspaces       Workspace[]
  workspaceMemberships  WorkspaceMember[]
  createdWorkspaceLists WorkspaceList[]
  activities            ActivityFeedItem[]
  comments              Comment[]
  assignedTodos         Todo[]            @relation("AssignedTodos")

  @@index([email])
}

model Todo {
  id          Int       @id @default(autoincrement())
  title       String
  description String
  dueDate     DateTime
  isComplete  Boolean   @default(false)
  priority    Priority  @default(MEDIUM)

  userId      Int
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Shared list relation (null if personal todo)
  listId      Int?
  list        SharedList? @relation(fields: [listId], references: [id], onDelete: Cascade)

  // Recurring todo relation (null if not a recurring instance)
  recurringTodoId  Int?
  recurringTodo    RecurringTodo? @relation(fields: [recurringTodoId], references: [id], onDelete: SetNull)
  recurringDate    DateTime?      // The specific date this instance represents

  // Workspace relation (null if personal todo)
  workspaceId      Int?
  workspace        Workspace? @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  workspaceListId  Int?
  workspaceList    WorkspaceList? @relation(fields: [workspaceListId], references: [id], onDelete: Cascade)

  assignedToId     Int?
  assignedTo       User? @relation("AssignedTodos", fields: [assignedToId], references: [id], onDelete: SetNull)

  deletedAt   DateTime?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  tags             TodoTag[]
  timeEntries      TimeEntry[]
  pomodoroSessions PomodoroSession[]
  calendarEvents   CalendarEvent[]
  comments         Comment[]

  @@index([dueDate])
  @@index([isComplete])
  @@index([priority])
  @@index([deletedAt])
  @@index([userId])
  @@index([listId])
  @@index([recurringTodoId])
  @@index([workspaceId])
  @@index([workspaceListId])
  @@index([assignedToId])
}

model Tag {
  id        Int       @id @default(autoincrement())
  name      String    @unique
  color     String?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  todos     TodoTag[]

  @@index([name])
}

model TodoTag {
  todoId    Int
  tagId     Int

  todo      Todo     @relation(fields: [todoId], references: [id], onDelete: Cascade)
  tag       Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  assignedAt DateTime @default(now())

  @@id([todoId, tagId])
  @@index([todoId])
  @@index([tagId])
}

model Subscription {
  id                    Int                @id @default(autoincrement())
  userId                Int                @unique
  user                  User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  tier                  SubscriptionTier   @default(FREE)
  status                SubscriptionStatus @default(ACTIVE)

  // Stubbed Stripe fields (will be null in stub mode)
  stripeCustomerId      String?            @unique
  stripeSubscriptionId  String?            @unique
  stripePriceId         String?

  currentPeriodStart    DateTime           @default(now())
  currentPeriodEnd      DateTime?
  cancelAtPeriodEnd     Boolean            @default(false)

  trialEndsAt           DateTime?

  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt

  billingHistory        BillingHistory[]

  @@index([userId])
  @@index([tier])
  @@index([status])
}

model PaymentMethod {
  id               Int      @id @default(autoincrement())
  userId           Int
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Stubbed payment method details
  type             String   // 'card', 'paypal', etc.
  last4            String?  // Last 4 digits of card
  brand            String?  // 'visa', 'mastercard', etc.
  expiryMonth      Int?
  expiryYear       Int?

  isDefault        Boolean  @default(false)

  // Stubbed Stripe field
  stripePaymentMethodId String? @unique

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([userId])
}

model BillingHistory {
  id             Int          @id @default(autoincrement())
  subscriptionId Int
  subscription   Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  amount         Float        // Amount in dollars
  currency       String       @default("usd")

  status         String       // 'succeeded', 'pending', 'failed'
  description    String

  // Stubbed Stripe fields
  stripeInvoiceId String?     @unique
  stripeChargeId  String?     @unique

  billingDate    DateTime     @default(now())
  paidAt         DateTime?

  createdAt      DateTime     @default(now())

  @@index([subscriptionId])
  @@index([billingDate])
}

model RecurringTodo {
  id          Int                 @id @default(autoincrement())
  userId      Int
  user        User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Template fields
  title       String
  description String
  priority    Priority            @default(MEDIUM)

  // Recurrence pattern (rrule format)
  frequency   RecurrenceFrequency
  interval    Int                 @default(1)  // e.g., every 2 weeks
  byWeekDay   String?              // JSON array: ["MO", "FR"] for weekly
  byMonthDay  Int?                 // For monthly: day of month (1-31)

  // Recurrence bounds
  startDate   DateTime
  endType     RecurrenceEndType   @default(NEVER)
  endDate     DateTime?            // For ON_DATE
  count       Int?                 // For AFTER_COUNT

  // Generation tracking
  lastGenerated DateTime?           // Last date we generated instances for
  isActive    Boolean             @default(true)

  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  // Relations
  instances   Todo[]
  exceptions  RecurrenceException[]

  @@index([userId])
  @@index([startDate])
  @@index([isActive])
}

model RecurrenceException {
  id              Int           @id @default(autoincrement())
  recurringTodoId Int
  recurringTodo   RecurringTodo @relation(fields: [recurringTodoId], references: [id], onDelete: Cascade)

  originalDate    DateTime      // The date this exception applies to
  action          String        // 'skip' or 'reschedule'
  newDate         DateTime?     // For reschedule action

  createdAt       DateTime      @default(now())

  @@index([recurringTodoId])
  @@index([originalDate])
  @@unique([recurringTodoId, originalDate])
}

model SharedList {
  id          Int      @id @default(autoincrement())
  name        String
  description String?
  color       String?  // Hex color for UI

  ownerId     Int
  owner       User     @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  isPublic    Boolean  @default(false)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  todos        Todo[]
  collaborators Collaborator[]

  @@index([ownerId])
  @@index([isPublic])
}

model Collaborator {
  id          Int              @id @default(autoincrement())
  listId      Int
  list        SharedList       @relation(fields: [listId], references: [id], onDelete: Cascade)

  userId      Int
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  role        CollaboratorRole @default(VIEWER)

  invitedAt   DateTime         @default(now())
  acceptedAt  DateTime?

  @@unique([listId, userId])
  @@index([listId])
  @@index([userId])
}

model TimeEntry {
  id          Int      @id @default(autoincrement())
  userId      Int
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  todoId      Int?
  todo        Todo?    @relation(fields: [todoId], references: [id], onDelete: SetNull)

  startTime   DateTime
  endTime     DateTime?
  duration    Int?     // Duration in seconds (calculated when ended)

  isActive    Boolean  @default(true)  // Only one can be active per user at a time
  description String?  // Optional note about what was done

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@index([todoId])
  @@index([startTime])
  @@index([isActive])
}

model PomodoroSession {
  id          Int                  @id @default(autoincrement())
  userId      Int
  user        User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  todoId      Int?
  todo        Todo?                @relation(fields: [todoId], references: [id], onDelete: SetNull)

  type        PomodoroSessionType  @default(WORK)
  duration    Int                  // Duration in minutes (25 for work, 5 for short break, 15 for long break)

  startTime   DateTime
  endTime     DateTime?
  completed   Boolean              @default(false)

  createdAt   DateTime             @default(now())

  @@index([userId])
  @@index([todoId])
  @@index([startTime])
  @@index([completed])
}

model Template {
  id          Int      @id @default(autoincrement())
  name        String
  description String?

  // Template content
  title       String
  content     String  // The template body with {{variable}} placeholders
  priority    Priority @default(MEDIUM)

  // Ownership
  userId      Int?     // null for system templates
  user        User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Categorization
  categoryId  Int?
  category    TemplateCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  isPublic    Boolean  @default(false)  // Public templates available to all users
  isSystem    Boolean  @default(false)  // System templates (curated)

  // Usage tracking
  useCount    Int      @default(0)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  variables   TemplateVariable[]

  @@index([userId])
  @@index([categoryId])
  @@index([isPublic])
  @@index([isSystem])
}

model TemplateVariable {
  id          Int                  @id @default(autoincrement())
  templateId  Int
  template    Template             @relation(fields: [templateId], references: [id], onDelete: Cascade)

  name        String                // Variable name (e.g., "client_name")
  label       String                // Display label (e.g., "Client Name")
  type        TemplateVariableType  @default(TEXT)

  defaultValue String?              // Default value if not provided
  required    Boolean              @default(false)

  // For SELECT type
  options     String?              // JSON array of options: ["Option 1", "Option 2"]

  // Ordering
  order       Int                  @default(0)

  createdAt   DateTime             @default(now())

  @@index([templateId])
}

model TemplateCategory {
  id          Int        @id @default(autoincrement())
  name        String     @unique
  description String?
  icon        String?    // Icon name or emoji
  color       String?    // Hex color

  isSystem    Boolean    @default(false)

  createdAt   DateTime   @default(now())

  templates   Template[]

  @@index([name])
}

model Notification {
  id          Int                 @id @default(autoincrement())
  userId      Int
  user        User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  type        NotificationType
  channel     NotificationChannel
  status      NotificationStatus  @default(PENDING)

  // Content
  title       String
  message     String
  actionUrl   String?             // Deep link to relevant todo/list

  // Related entity (optional)
  todoId      Int?
  listId      Int?

  // Delivery tracking
  sentAt      DateTime?
  readAt      DateTime?
  failedAt    DateTime?
  errorMessage String?

  // Scheduling
  scheduledFor DateTime?          // For delayed notifications
  snoozedUntil DateTime?          // For snoozed notifications

  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  @@index([userId])
  @@index([status])
  @@index([type])
  @@index([scheduledFor])
  @@index([snoozedUntil])
}

model NotificationSettings {
  id                    Int              @id @default(autoincrement())
  userId                Int              @unique
  user                  User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Channel preferences
  emailEnabled          Boolean          @default(true)
  browserPushEnabled    Boolean          @default(true)
  inAppEnabled          Boolean          @default(true)

  // Notification type preferences
  taskDueSoonEnabled    Boolean          @default(true)
  taskDueSoonHours      Int              @default(24)  // How many hours before due date
  taskOverdueEnabled    Boolean          @default(true)
  taskAssignedEnabled   Boolean          @default(true)
  taskCompletedEnabled  Boolean          @default(false)

  // Digest preferences
  digestFrequency       DigestFrequency  @default(DAILY)
  digestTime            String           @default("09:00")  // HH:mm format
  digestDaysOfWeek      String?          // For WEEKLY: JSON array ["MON", "FRI"]

  // Quiet hours
  quietHoursEnabled     Boolean          @default(false)
  quietHoursStart       String?          // HH:mm format
  quietHoursEnd         String?          // HH:mm format

  // List/tag-specific overrides (future enhancement)
  mutedListIds          String?          // JSON array of list IDs
  mutedTagIds           String?          // JSON array of tag IDs

  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt

  @@index([userId])
}

model NotificationRule {
  id          Int      @id @default(autoincrement())
  userId      Int

  name        String
  description String?
  isActive    Boolean  @default(true)

  // Trigger conditions
  triggerType String   // 'due_soon', 'overdue', 'tag_match', 'priority_match', 'custom'
  conditions  String   // JSON object with rule conditions

  // Action
  channel     NotificationChannel
  message     String   // Template string with variables

  // Frequency control
  maxPerDay   Int?     // Limit notifications per day
  lastSent    DateTime?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@index([isActive])
}

model CalendarConnection {
  id          Int              @id @default(autoincrement())
  userId      Int
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  provider    CalendarProvider

  // OAuth credentials (encrypted in production)
  accessToken     String
  refreshToken    String?
  tokenExpiresAt  DateTime?

  // Provider-specific IDs
  providerUserId      String?  // User ID from calendar provider
  providerCalendarId  String?  // Default calendar ID to sync with

  // Sync settings
  syncDirection       SyncDirection  @default(BIDIRECTIONAL)
  syncStatus          SyncStatus     @default(ACTIVE)
  lastSyncAt          DateTime?
  lastSyncError       String?

  // Sync preferences
  syncEnabled         Boolean        @default(true)
  autoCreateEvents    Boolean        @default(true)
  syncCompletedTodos  Boolean        @default(false)
  eventDuration       Int            @default(60)  // Default event duration in minutes

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  events      CalendarEvent[]

  @@unique([userId, provider])
  @@index([userId])
  @@index([syncStatus])
}

model CalendarEvent {
  id          Int      @id @default(autoincrement())

  connectionId Int
  connection   CalendarConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  todoId      Int?
  todo        Todo?    @relation(fields: [todoId], references: [id], onDelete: SetNull)

  // Provider event ID for sync
  providerEventId  String

  // Event data
  title       String
  description String?
  startTime   DateTime
  endTime     DateTime
  location    String?

  // Sync metadata
  lastSyncedAt     DateTime  @default(now())
  syncedFromTodo   Boolean   @default(false)  // True if event was created from a todo
  modifiedInCalendar Boolean @default(false)  // True if event was modified in calendar

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([connectionId, providerEventId])
  @@index([connectionId])
  @@index([todoId])
  @@index([startTime])
}

model Workspace {
  id          Int      @id @default(autoincrement())
  name        String
  description String?

  ownerId     Int
  owner       User     @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  settings    String?  // JSON for workspace preferences

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  members     WorkspaceMember[]
  todos       Todo[]
  lists       WorkspaceList[]
  activities  ActivityFeedItem[]
  comments    Comment[]

  @@index([ownerId])
}

model WorkspaceMember {
  id          Int      @id @default(autoincrement())
  workspaceId Int
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  userId      Int
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  role        WorkspaceMemberRole @default(MEMBER)

  invitedAt   DateTime @default(now())
  joinedAt    DateTime?
  invitedBy   Int?     // userId who sent invite

  @@unique([workspaceId, userId])
  @@index([workspaceId])
  @@index([userId])
}

model WorkspaceList {
  id          Int      @id @default(autoincrement())
  workspaceId Int
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  name        String
  description String?
  color       String?

  createdById Int
  createdBy   User     @relation(fields: [createdById], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  todos       Todo[]

  @@index([workspaceId])
  @@index([createdById])
}

model ActivityFeedItem {
  id          Int      @id @default(autoincrement())
  workspaceId Int
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  actorId     Int
  actor       User     @relation(fields: [actorId], references: [id], onDelete: Cascade)

  action      ActivityAction
  entityType  String   // 'todo', 'list', 'member', etc.
  entityId    Int?

  metadata    String?  // JSON with action details

  createdAt   DateTime @default(now())

  @@index([workspaceId])
  @@index([actorId])
  @@index([createdAt])
}

model Comment {
  id          Int      @id @default(autoincrement())
  workspaceId Int
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  todoId      Int
  todo        Todo     @relation(fields: [todoId], references: [id], onDelete: Cascade)

  authorId    Int
  author      User     @relation(fields: [authorId], references: [id], onDelete: Cascade)

  content     String
  mentions    String?  // JSON array of mentioned userIds

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([todoId])
  @@index([workspaceId])
  @@index([authorId])
}
